<?php
namespace app\index\controller;
use app\common\help\Help;
use think\config ;
use app\index\model\btob\Distributor;
use app\index\model\branchcompany\CompanyOrder;
use app\index\model\branchcompany\CompanyOrderProduct;
use app\index\model\branchcompany\CompanyOrderCustomer;
use app\index\model\system\BillTemplate;
use think\Model;
use think\Controller;
class Btob extends Base
{
	private $_language;
	private $_company_order;
	private $_company_order_product;
	private $_company_order_customer;
	private $_bill_template;
    //_lang Base里的属性，
    public function __construct()
    {
    	$this->_language = config("systom_setting")['language_default'];
    	$this->_company_order =new CompanyOrder();
    	$this->_company_order_product =new CompanyOrderProduct();
    	$this->_company_order_customer =new CompanyOrderCustomer();
    	$this->_bill_template = new BillTemplate();
        parent::__construct();
    }
    
    /**
     * 添加分销商数据
     * 胡
     */
    public function addDistributor(){
    
    	$params = $this->input();
    
    	$paramRule = [
 			'company_id' => 'mumber',
    		'distributor_name'=>'string',
    		'associate_type'=>'string',
    		'status'=>'number',
    		'user_id'=>'number'	
    	];
    	$this->paramCheckRule($paramRule,$params);

        //首先判断名字是否有重复
        $data = [
            'distributor_name'=>$params['distributor_name'],
        ];
        $this->checkNameIsRepetition('distributor',$data);
        //结束判断名字重复
    
    	$distributor = new Distributor();
    	$distributor_result = $distributor->addDistributor($params);
    
    	$this->outPut($distributor_result);
    }
    /**
     * 获取分销商数据
     * 胡
     */
    public function getDistributor(){
    
    
    	$params = $this->input();
    
    	$distributor = new Distributor();
		
        if(isset($params['page'])){
            $page_size =  isset($params['page_size'])?$params['page_size']:Contents::PAGE_SIZE;
            $page = ($params['page']-1)*$page_size;
            $count = $distributor->getDistributor($params, true);
            $result = $distributor->getDistributor($params,false,'true',$page,$page_size);
            $data = [
                'count'=>$count,
                'list'=>$result,
                'page_count'=>ceil($count/$page_size)
            ];

            return $this->output($data);
        }
    	$distributor_result = $distributor->getDistributor($params);
    
    	$this->outPut($distributor_result);
    
    }
    
    /**
     * 修改分销商
     * 胡
     */
    
    public function updateDistributorByDistributorId(){
    	$params = $this->input();
    
    	$paramRule = [
 			'distributor_id' => 'number',
    		'user_id'=>'number',
    
    	];
    	
    	$this->paramCheckRule($paramRule,$params);
    	$distributor = new Distributor();
    	$distributor_result = $distributor->updateDistributorByDistributorId($params);
    	$this->outPut($distributor_result);
    
    
    }    

    /**
     * 获取分销商账单 
     */
    public function getDistributorBill(){
    	$params = $this->input();
    	
    	$paramRule = [
    		'distributor_id' => 'number', 
    		'bill_template_id'=>'number'	
    	];
    
    	$this->paramCheckRule($paramRule,$params);
    	$company_order_create_from_time = $params['company_order_create_from_time'];
    	$company_order_create_to_time = $params['company_order_create_to_time'];
    	$company_order_begin_time = $params['company_order_begin_time'];
    	$company_order_end_time = $params['company_order_end_time'];
    	$hidden_sale_over = $params['hidden_sale_over'];
    	
    	$branch_product_number_one = $params['branch_product_number'];
    	
    	//首先获取账单数据
    	$bill_template_params = [
    		'bill_template_id'=>$params['bill_template_id']
    	];
    	$bill_result = $this->_bill_template->getBillTemplate($bill_template_params);
    	
    	//首先获取所有的订单数据
    	$distributor_bill = [];
    	$distributor_bill['bill_template_title_pic'] = $bill_result[0]['bill_template_title_pic'];
    	$distributor_bill['bill_template_foot_pic'] = $bill_result[0]['bill_template_foot_pic'];
    	$company_order_result = $this->_company_order->getCompanyOrderForDistributorBill($params);
    	$distributor_bill['company_order_count'] = count($company_order_result);
    	$company_order_customer_count=0;
  

//     	$new_bill_data = [];

//     	for($i=0;$i<count($company_order_result);$i++){
//     		if(!empty($branch_product_number_one)){
//     			if($branch_product_number_one==$company_order_result[$i]['branch_product_number']){
    	
//     				if($hidden_sale_over==1){
//     					if($company_order_result[$i]['miss_payment']>0){
//     						$new_bill_data[] = $company_order_result[$i];
//     					}
//     				}else{
//     					$new_bill_data[] = $company_order_result[$i];
//     				}
    				 
//     			}
//     		}else{    			 
//     			if($hidden_sale_over==1){
//     				//error_log(print_r($new_company_order_result[$i]['miss_payment'],1));
//     				if($company_order_result[$i]['miss_payment']>0){
//     					$new_bill_data[] = $company_order_result[$i];   						
//     				}
//     			}else{   	
//     				$new_bill_data[] = $company_order_result[$i];
//     			}    			 
//     		}    	    	
//     	}

    	$new_bill_data = $company_order_result;
    	//开始计算总的应收
    	$total=0;
    	//实收
    	$paid=0;
    	$currency_info = [];
    	$new_company_order_result = [];
    	for($i=0;$i<count($new_bill_data);$i++){//开始查询订单下有几个分公司产品
    		$new_bill_data[$i]['miss_payment'] = number_format($new_bill_data[$i]['payment_money']-$new_bill_data[$i]['true_payment'],2);
    		$new_bill_data[$i]['payment_money'] = number_format($new_bill_data[$i]['payment_money'],2);
    		$new_bill_data[$i]['true_payment'] = number_format($new_bill_data[$i]['true_payment'],2);
    		if($hidden_sale_over==1){
    			if($new_bill_data[$i]['miss_payment']<=0){
    				continue;
    			}
    		}
    		$branch_product_number='';
    		if(!empty($params['branch_product_number'])){
    			$company_order_product_params = [
    				'status'=>1,
    				'company_order_number'=>$new_bill_data[$i]['company_order_number'],
    				'branch_product_number'=>$params['branch_product_number']
    			];
    		}else{
    			$company_order_product_params = [
    				'status'=>1,
    				'company_order_number'=>$new_bill_data[$i]['company_order_number'],
    				
    			];
    		}

    		$company_order_product_result = $this->_company_order_product->getCompanyOrderProduct($company_order_product_params);
    		if(count($company_order_product_result)==0){
    			continue;
    		}
    		//开始循环名字
    		$company_order_product_name='';
    		for($j=0;$j<count($company_order_product_result);$j++){
    			if($j==0){
    				$company_order_product_name=$company_order_product_result[$j]['branch_product_name'];
    				$branch_product_number=$company_order_product_result[$j]['branch_product_number'];
    			}else{
    				$company_order_product_name.=','.$company_order_product_result[$j]['branch_product_name'];
    				$branch_product_number.=','.$company_order_product_result[$j]['branch_product_number'];
    			}
    		}
    		$new_bill_data[$i]['company_order_product_name'] = $company_order_product_name;
    		$new_bill_data[$i]['branch_product_number'] = $branch_product_number;
    		//查询每个订单有多少个游客
    		$company_order_customer_params = [
    			'company_order_number'=>$new_bill_data[$i]['company_order_number']	
    		];
    		$company_order_customer_result = $this->_company_order_customer->getCompanyOrderCustomer($company_order_customer_params);
    		$new_bill_data[$i]['company_order_customer_count'] = count($company_order_customer_result);
    		$company_order_customer_count+=count($company_order_customer_result);
    		
    		$total+=$new_bill_data[$i]['payment_money'];
    		$paid+=$new_bill_data[$i]['true_payment'];
    		
    		

    		//开始计算每个币种的总价 已付 未付
    		$currency_info[$new_bill_data[$i]['receivable_currency_id']]['currency_id']=$new_bill_data[$i]['receivable_currency_id'];
    		$currency_info[$new_bill_data[$i]['receivable_currency_id']]['unit']=$new_bill_data[$i]['unit'];
    		
    		$currency_info[$new_bill_data[$i]['receivable_currency_id']]['currency_name']=$new_bill_data[$i]['currency_name'];
    		$currency_info[$new_bill_data[$i]['receivable_currency_id']]['total']+=$new_bill_data[$i]['payment_money'];
    		$currency_info[$new_bill_data[$i]['receivable_currency_id']]['paid']+=$new_bill_data[$i]['true_payment'];
    		$currency_info[$new_bill_data[$i]['receivable_currency_id']]['balance']+=$new_bill_data[$i]['payment_money']-$new_bill_data[$i]['true_payment'];
    		$company_order_customer_name='';
    		//开始算人名
    		for($k=0;$k<count($company_order_customer_result);$k++){
    			if($k==0){
    				$company_order_customer_name=$company_order_customer_result[$k]['customer_name'];
    			}else{
    				$company_order_customer_name.=','.$company_order_customer_result[$k]['customer_name'];
    			}
    		}
    		$new_bill_data[$i]['company_order_customer_name'] = $company_order_customer_name;
    		
    		$new_company_order_result[] = $new_bill_data[$i];
    	}
    	
   
    	

    
    	$distributor_bill['company_order_customer_count'] = $company_order_customer_count;
    	$distributor_bill['total'] = number_format($total,2);
    	$distributor_bill['paid'] = number_format($paid,2);
    	$distributor_bill['balance'] = number_format($total-$paid,2);
    	$distributor_bill['bill_data'] = $new_company_order_result;
    	$currency_info = array_values($currency_info);
    	for($i=0;$i<count($currency_info);$i++){
    		$currency_info[$i]['total'] = number_format($currency_info[$i]['total'],2);
    		$currency_info[$i]['paid'] = number_format($currency_info[$i]['paid'],2);
    		$currency_info[$i]['balance'] = number_format($currency_info[$i]['balance'],2);
    		
    		
    	}
    	$distributor_bill['currency_info'] = $currency_info;
    	$this->outPut($distributor_bill);
    }
}	
