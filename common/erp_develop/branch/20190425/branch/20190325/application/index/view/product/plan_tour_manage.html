<!DOCTYPE html>
<html>
<head>
    {include file='public/head' /}
    <title>团队产品</title>
    <link href="__STATIC__/css/product.css" rel="stylesheet">
    <style>
        .layui-body{
            overflow: hidden;
        }
        .layui-body .layui-table-main{
            overflow: auto;
            height:350px;
            margin-top:10px;
            border-top:1px solid #e6e6e6;
        }
        .layui-body table{
            margin:0px;
        }
        @media screen and (min-width:1680px){
            .layui-body .layui-table-main{
                height:580px;
            }
        }
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        {include file='public/header' /}
    </div>

    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            {include file='public/left_menu' /}
        </div>
    </div>

    <div class="layui-body layui-body-bg">

        <!-- 内容主体区域 -->
        <div style="padding: 15px 15px 0px;">
            <div class="body-top">
                <div class='layui-form-item'>
                    <span class="layui-breadcrumb" lay-separator="-">
                        <a>{$Think.lang.index_public_homepage}</a>
                        <a>{$Think.lang.index_public_product}</a>
                        <a><cite>{$Think.lang.index_product_ShowPlanTour_resources_teamProduct}</cite></a>
                    </span>
                </div>
                <div class='layui-block all-search-bg'>
                    <form class="layui-form" action="/product/setPlanTourManage" method="post" >
                        <div class="layui-row">
                            <div class="layui-col-md4">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{$Think.lang.index_product_ShowPlanTour_productNumber}:</label>
                                    <div class="layui-input-block">
                                        <input type="text"   name="search_code" value="{$setPlanTourManage.search_code}"  placeholder="产品编号" class="layui-input">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{$Think.lang.index_product_ShowPlanTour_teamName}:</label>
                                    <div class="layui-input-block">
                                        <input type="text"   name="search_name" value="{$setPlanTourManage.search_name}"  placeholder="团队名称" class="layui-input">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md4">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">{$Think.lang.index_public_status}:</label>
                                    <div class="layui-input-block">
                                        <select  id="search_status" name="search_status">
                                            <option value="-1"  >-{$Think.lang.index_public_search_type}-</option>
                                            {foreach $PlanTourState as $k=>$vl}
                                            <option value="{$k}" {$setPlanTourManage.search_status==$k?'selected':''}>{$vl}</option>
                                            {/foreach}

                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="layui-col-md4">
                            <div class="layui-form-item">
                                <label class="layui-form-label">线路类型:</label>
                                <div class="layui-input-block">
                                    <select name='search_route_type'>
                                        <option></option>
                                        <optgroup label='华人团'>
                                            <!--<option value="-1">所有华人团</option>-->
                                            {foreach $RouteType[1] as $vl}
                                            <option value="{$vl.route_type_id}" {$setPlanTourManage.search_route_type==$vl.route_type_id?'selected':''}>{$vl.route_type_name}</option>
                                            {/foreach}
                                        </optgroup>
                                        <optgroup label='老外团'>
                                            <!--<option value="-2">所有老外团</option>-->
                                            {foreach $RouteType[2] as $vl}
                                            <option value="{$vl.route_type_id}" {$setPlanTourManage.search_route_type==$vl.route_type_id?'selected':''} >{$vl.route_type_name}</option>
                                            {/foreach}
                                        </optgroup>
                                        <optgroup label='其他'>
                                            <!--<option value="-3">所有其他</option>-->
                                            {foreach $RouteType[3] as $vl}
                                            <option value="{$vl.route_type_id}" {$setPlanTourManage.search_route_type==$vl.route_type_id?'selected':''} >{$vl.route_type_name}</option>
                                            {/foreach}
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md4">
                            <div class="layui-form-item">
                                <label class="layui-form-label">团队负责人:</label>
                                <div class="layui-input-block">
                                    <input  type="text" class="layui-input" name="search_responsible_person" value="{$setPlanTourManage.search_responsible_person}" />
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md4">
                            <div class="layui-form-item">
                                <label class="layui-form-label">出团日期:</label>
                                <div class="layui-input-block">
                                    <input  type="text" class="layui-input all_time_name" name="search_all_time_name" value="{$setPlanTourManage.search_all_time_name}" />
                                </div>
                            </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-col-md4 layui-col-md-offset4">
                                <div class='input-inline all-button-center pages-search-margin'>
                                    <button class="layui-btn nav-search">{$Think.lang.index_public_search}</button>
                                </div>
                            </div>
                        </div>
                        <!--<div class='layui-button-inline layui-search-inline'>&lt;!&ndash;  layui-button-inline layui-search-inline plan-margin&ndash;&gt;
                            <button class="layui-btn nav-search">搜索</button>

                        </div>-->

                    </form>
<!--                        <div class='layui-button-inline'>&lt;!&ndash;  layui-button-inline plan-margin&ndash;&gt;
                            <a href='/product/showPlanTourAdd' class="layui-btn nav-add">添加团队产品</a>
                            &lt;!&ndash;<a class="layui-btn pintuan nav-add">拼团</a>&ndash;&gt;
                            &lt;!&ndash;<a class="layui-btn">分团</a>&ndash;&gt;
                        </div>-->
                </div>
            </div>
            <div class="content-bg">
                <span style="{:action('index/auth/check_auth',['role_id'=>'228'])}"><a href='/product/showPlanTourAdd' class="layui-btn nav-add layui-btn-sm">{$Think.lang.index_product_ShowPlanTour_addingTeamProducts}</a></span>
                <span style="{:action('index/auth/check_auth',['role_id'=>'235'])}"><a class="layui-btn layui-btn-sm pintuan nav-add">拼团</a></span>
                <hr>
                <div  class="table-nont user-manage newBg-pageHeight" style="display: block;">
                <table class="layui-table layui-form" id="language-table" style="table-layout:fixed;">
                    <colgroup>
                        <col width="50">
                        <col width="100">
                        <!--<col width="200">-->
                        <col width="200">
                        <col width="250">
                        <col width="80">
                        <col width="150">
                        <col width="150">
                        <col width="400">
                        <col width="150">
                        <col width="100">
                        <col width="100">
                        <col width="120">
                        <col width="150">
                        <col width="340">
                    </colgroup>
                    <thead>
                    <tr>
                        <th><input id="" type="checkbox" title="" lay-skin="primary" lay-filter="all_checkbox_id" /></th>
                        <th>{$Think.lang.index_public_status}</th>
                        <!--<th>拼团编号</th>-->
                        <th>{$Think.lang.index_product_ShowPlanTour_productNumber}</th>
                        <th>{$Think.lang.index_product_ShowPlanTour_teamName}</th>
                        <th>{$Think.lang.index_product_showRouteTemplateManage_days}</th>
                        <th>{$Think.lang.index_product_showRouteTemplateManage_routeType}</th>
                        <th>{$Think.lang.index_product_ShowPlanTour_departureDate}</th>
                        <th>{$Think.lang.index_product_showRouteTemplateManage_resourceAllocation}</th>
                        <th>{$Think.lang.index_product_showRouteTemplateManage_userName}</th>
                        <th>{$Think.lang.index_product_ShowPlanTour_planToReceiveVisitors}</th>
                        <th>{$Think.lang.index_product_ShowPlanTour_receivedVisitors}</th>
                        <!--<th>本公司收客</th>-->
                        <th>{$Think.lang.index_product_showRouteTemplateManage_updateTime}</th>
                        <th>{$Think.lang.index_product_ShowPlanTour_operatingPersonnel}</th>
                        <th>{$Think.lang.index_source_operation}</th>
                    </tr>
                    </thead>

                    <tbody>

                    {foreach name="data" item="vl"}
                    <tr>
                        <th>
                            {if $vl.status!=3}
                            <input class="checkbox_id" value="{$vl.team_product_id}" type="checkbox" title="" lay-skin="primary" />
                            {/if}
                        </th>
                        <th>{$vl.is_establish_team_product?$is_establish_team_product[$vl.is_establish_team_product]:$PlanTourState[$vl.status]}</th>
                        <!--<th>空</th>-->
                        <th>{$vl.team_product_number}</th>
                        <th>{$vl.team_product_name}</th>
                        <th>{$vl.base_count}</th>
                        <th>{$vl.route_type_name}</th>
                        <th><?=date('Y-m-d',$vl['begin_time']);?></th>
                        <th>{$vl.source}</th>
                        <th>{$vl.team_product_user_name}</th>
                        <th>{$vl.plan_custom_number}</th>
                        <th>{$vl.stance|default=0}</th>
                        <!--<th>本公司收客</th>-->
                        <th><?=date('Y-m-d',$vl['update_time'])?></th>
                        <th>{$vl.update_user_name}</th>

                        {if $vl.status!=3}
                        <th>
                            <span style="{:action('index/auth/check_auth',['role_id'=>'229'])}"><a href="/product/showPlanTourUpdate?plan_id={$vl.team_product_id}" class="layui-btn layui-btn-sm hover-edit layui-btn-primary">{$Think.lang.index_public_update}</a></span>
                            <span style="{:action('index/auth/check_auth',['role_id'=>'230'])}"><a href="/product/showPlanTourInfo?plan_id={$vl.team_product_id}" class="layui-btn layui-btn-sm hover-edit layui-btn-primary">详情</a></span>
                            <span style="{:action('index/auth/check_auth',['role_id'=>'231'])}"><a class="layui-btn layui-btn-sm hover-edit layui-btn-primary" href="/product/PlanBooking?plan_id={$vl.team_product_id}&number={$vl.team_product_number}">{$Think.lang.index_product_ShowPlanTour_product_number}</a></span>
                            <span style="{:action('index/auth/check_auth',['role_id'=>'232'])}"><a class="layui-btn layui-btn-sm hover-edit layui-btn-primary" href="/product/showshowPlanTourGuideReceipt?number={$vl.team_product_number}">{$Think.lang.index_product_ShowPlanTour_guideBack}</a></span>
                            <span style="{:action('index/auth/check_auth',['role_id'=>'233'])}"><a class="layui-btn layui-btn-sm hover-edit layui-btn-primary" href="/product/PlanSuppliersPayable?plan_id={$vl.team_product_id}&number={$vl.team_product_number}">{$Think.lang.index_product_ShowPlanTour_suppliersPayable}</a></span>
                            <!--<a href="/product/showPlanTourInfo?plan_id={$vl.team_product_id}" class="layui-btn">详情</a>-->
                            {if $vl.is_establish_team_product<>1}
                            <span style="{:action('index/auth/check_auth',['role_id'=>'234'])}"><a class="layui-btn layui-btn-sm hover-edit layui-btn-primary chengtuan" data-info2="{$vl.team_product_id}" data-info="{$vl.team_product_number}">成团</a></span>
                            {/if}
                            <!--<a class="layui-btn">团队状态</a>-->
                        </th>
                        {else/}
                            <th>
                                <span style="{:action('index/auth/check_auth',['role_id'=>'230'])}"><a href="/product/showPlanTourAuditingInfo?plan_id={$vl.team_product_id}" class="layui-btn layui-btn-sm hover-edit layui-btn-primary">详情</a></span>
                            </th>
                        {/if}

                    </tr>
                    {/foreach}
                    </tbody>

                </table>
                    
                </div>
             	{include file='public/page' /}
            </div>

             <div class="listButtom" >
               
        	</div>
        </div>
        

    </div>

    <div class="layui-footer">
        <!-- 底部固定区域 -->
        © layui.com - 底部固定区域
    </div>
</div>
{include file='public/foot_js' /}

<script id="T-PinTuan" type="text/html">
<form id="F-PinTuan" >
    <table class="layui-table" style="width:80%;margin: 10px auto">
        <thead>
        <tr>
            <th>{$Think.lang.index_product_ShowPlanTour_pinNumber}</th><th>{$Think.lang.index_product_ShowPlanTour_productNumber}</th><th>{$Think.lang.index_product_ShowPlanTour_teamName}</th>
        </tr>
        </thead>
        <tbody>
        {{# for(var i = 0, len = d.length; i < len; i++){ }}
        <tr>
            {{# if(i==0){ }}
            <td rowspan="{{d.length}}">{$Think.lang.index_product_ShowPlanTour_pinNumber}</td>
            {{# } }}
            <td>{{d[i].team_product_number}}</td>
            <td>{{d[i].team_product_name}}</td>
            <input type="hidden" name="team_product_id[{{i}}]" value="{{d[i].team_product_id}}" />
        </tr>
        {{# } }}
        </tbody>
    </table>
    <div style="text-align: center;margin-bottom: 10px">
        <a class="layui-btn layui-btn-primary cancel">{$Think.lang.index_public_cancel}</a>&nbsp;&nbsp;&nbsp; <a class="layui-btn layui-btn-normal confirm">{$Think.lang.index_public_ok}</a>
    </div>
</form>
</script>


<script>
    //JavaScript代码区域
    !function(){
        var layer = layui.layer ;
        var form = layui.form;
        var laydate = layui.laydate;
        var table=layui.table;
        var laytpl=layui.laytpl;

        //常规用法
        laydate.render({
            elem: '#search_sdata'
            ,lang: 'zn'
        });
        laydate.render({
            elem: '#search_edata'
            ,lang: 'zn'
        });
        laydate.render({
            elem: '.all_time_name'
            ,lang: 'zn'
        });

        //成团
        var chentuan_button;
        $('.chengtuan').click(function(){
            layer.load(2);
            var team_product_number =  $(this).data('info');
            var team_product_id = $(this).data('info2');
//            alert(team_product_number);
            chentuan_button = $(this);
            $.post('/product/chengTuan',{team_product_number:team_product_number,team_product_id:team_product_id},function(){
                layer.closeAll();
                chentuan_button.parent().parent().find('th').eq(1).html('成团');
                chentuan_button.remove();
            });


        });

        //全选
        form.on('checkbox(all_checkbox_id)', function(data){
            var child = $(data.elem).parents('thead').siblings("tbody").find('th input[type="checkbox"]');
            child.each(function(index, item){
                item.checked = data.elem.checked;
            });
            form.render('checkbox');
        });


        $('.pintuan').on('click',function(){
            var newQ = new Array();
            $('.checkbox_id').each(function(index, item) {
                if (item.checked == true) {
                    newQ.push(item.value);
                }
            });
            if(newQ.length<=1){
                layer.msg('{$Think.lang.index_product_ShowPlanTour_placeholderConglomeration}');
                return;
            }
            layer.load(2);
            $.post('/product/ConglomerationAjax',{'newQ':newQ},function(a){
                layer.closeAll('loading'); //关闭loading
                console.log(a);
                if(a.code==400){
                    layer.msg('{$Think.lang.index_product_ShowPlanTour_placeholderConglomeration}');
                    return;
                }

                var html = $('#T-PinTuan').html();
                laytpl(html).render(a.data, function(htmll){
                    layer.open({
                        title:'',
                        type: 1,
                        area: ['60%','600px'],
                        content: htmll //这里content是一个普通的String
                    });
                });

                //取消
                $('.cancel').on('click',function(){
                    layer.closeAll();
                });

                //确认
                $('.confirm').on('click',function(){
                    layer.load(2);
                    $.post('/product/ConfirmConglomerationAjax',$('#F-PinTuan').serializeArray(),function(a){
                        layer.closeAll('loading'); //关闭loading
                        if(a.code==400){
                            layer.msg('{$Think.lang.index_public_verificationFailure}');
                        }else{
                            layer.msg('{$Think.lang.index_public_success}',{time:1});
                            layer.closeAll();
                        }
                        return;
                    },'json');
                });



            },'json');
        });

        /*按钮*/
        button()
        $(window).resize(function () {
            button()
        });
        function button() {
            var planHeight=$(".plan-tour-form").height();
            if(planHeight<=43){
                $(".plan-tour-form").css("padding-bottom","45px")
            }
        }

    }();

</script>
</body>
</html>